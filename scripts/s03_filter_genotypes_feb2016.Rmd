---
title: "Filter genotypes, wecare feb2016"
author: "Alexey Larionov"
output: html_document
---

started: Mar2016
last updated: 27Apr2016

Takes ~2hrs for wecare dataset 
because of two cycles in
(i) ad table splitting and 
(ii) filtering by ad

# start_section

```{r start_section}

# Time stamp
Sys.time()

# Clean-up
rm(list=ls())
graphics.off()

# Set root working folder
library(knitr)

#opts_knit$set(root.dir = "/scratch/medgen/scripts/rscripts_05.16")
#setwd("/scratch/medgen/scripts/rscripts_05.16")

#opts_knit$set(root.dir = "C:\\Users\\larion01\\Documents\\GitHub\\R1")
#setwd("C:\\Users\\larion01\\Documents\\GitHub\\R1")

```

# filtering_settings

```{r filtering_settings}

min.dp <- 10
min.gq <- 20

hom.maf.max <- 5
het.maf.min <- 25

```

# load_and_check_data

```{r load_and_check_data}

load(file="data/s02_filter_variants_feb2016.RData")
ls()

dim(covar.df)
colnames(covar.df)
str(covar.df)
covar.df[1:5,1:5]

dim(demographics.df)
colnames(demographics.df)
str(demographics.df)
demographics.df[1:5,1:5]

dim(samples.df)
colnames(samples.df)
str(samples.df)
samples.df[1:5,]

dim(vv.pf.df)
colnames(vv.pf.df)
str(vv.pf.df)
vv.pf.df[1:5,1:3]

dim(gt.pf.df)
gt.pf.df[1:5,1:3]

dim(gq.pf.df)
gq.pf.df[1:5,1:3]

dim(dp.pf.df)
dp.pf.df[1:5,1:3]

dim(ad.pf.df)
ad.pf.df[1:5,1:3]

# Check consistence of rownames
sum(rownames(gt.pf.df) != rownames(vv.pf.df), na.rm=TRUE)

sum(rownames(gt.pf.df) != rownames(gq.pf.df), na.rm=TRUE)
sum(rownames(gt.pf.df) != rownames(dp.pf.df), na.rm=TRUE)
sum(rownames(gt.pf.df) != rownames(ad.pf.df), na.rm=TRUE)

# Check consistence of colnames (sub(".DP","") may be used instead)
sum(substr(colnames(gt.pf.df),0,6) != substr(colnames(gq.pf.df),0,6), na.rm=TRUE)
sum(substr(colnames(gt.pf.df),0,6) != substr(colnames(dp.pf.df),0,6), na.rm=TRUE)
sum(substr(colnames(gt.pf.df),0,6) != substr(colnames(ad.pf.df),0,6), na.rm=TRUE)

```

# prepare_tables

```{r prepare_tables}

# Reduce data size for development
#gt.pf.df <- gt.pf.df[1:1000,]
#gq.pf.df <- gq.pf.df[1:1000,]
#dp.pf.df <- dp.pf.df[1:1000,]
#ad.pf.df <- ad.pf.df[1:1000,]

# Converet to matrices
gt.mx <- as.matrix(gt.pf.df)
gq.mx <- as.matrix(gq.pf.df)
dp.mx <- as.matrix(dp.pf.df)
ad.mx <- as.matrix(ad.pf.df)
rm(gt.pf.df, gq.pf.df, dp.pf.df, ad.pf.df)

# Split ad table into two (ref,alt)
ref.mx <- ad.mx
alt.mx <- ad.mx

for (row in 1:nrow(ad.mx)){
  for (col in 1:ncol(ad.mx)){
    ref.alt <- strsplit(ad.mx[row,col],",")[[1]]
    ref.mx[row,col] <- ref.alt[1]
    alt.mx[row,col] <- ref.alt[2]
  }
}

rm(row, col, ref.alt)

# Convert new tables to numeric
ad.rownames <- rownames(ad.mx)
ad.colnames <- colnames(ad.mx)

ref.mx <- matrix(as.numeric(ref.mx),nrow=nrow(ref.mx))
rownames(ref.mx) <- ad.rownames
colnames(ref.mx) <- ad.colnames

alt.mx <- matrix(as.numeric(alt.mx),nrow=nrow(alt.mx))
rownames(alt.mx) <- ad.rownames
colnames(alt.mx) <- ad.colnames

rm(ad.rownames, ad.colnames)

# Total num of NAs before genotype filtering
sum(is.na(gt.mx))/(dim(gt.mx)[1]*dim(gt.mx)[2])

```

# filter_by_gq

```{r filter_by_gq}

# Apply filter
NA -> gt.mx[ gq.mx < min.gq ]
rm(gq.mx, min.gq)

# Total num of NAs after filter
sum(is.na(gt.mx))/(dim(gt.mx)[1]*dim(gt.mx)[2])

```

# filter_by_dp

```{r filter_by_dp}

# Apply filter
NA -> gt.mx[ dp.mx < min.dp ]
rm(dp.mx, min.dp)

# Total num of NAs after filter
sum(is.na(gt.mx))/(dim(gt.mx)[1]*dim(gt.mx)[2])

```

# filter_by_ad

```{r filter_by_ad}

# For each genotype
for (row in 1:nrow(gt.mx)){
  for (col in 1:ncol(gt.mx)){
    
    # For not missed genotypes
    if (!is.na(gt.mx[row,col])){
  
      # Calculate maf 
      ref <- ref.mx[row,col]
      alt <- alt.mx[row,col]
      sum <- ref + alt
      maf <- min(ref,alt)/sum
      
      # Remove homozigous genotypes with high maf
      if(gt.mx[row,col]==0 | gt.mx[row,col]==2){
        if(maf > hom.maf.max){ NA -> gt.mx[row,col] }
      }
      
      # Remove heterozigous genotypes with low maf
      if(gt.mx[row,col]==1){
        if(maf < het.maf.min){ NA -> gt.mx[row,col] }
      }
      
    }
  }
}

rm(row, col, ref, alt, sum, maf, het.maf.min, hom.maf.max)

# Total num of NAs after filter
sum(is.na(gt.mx))/(dim(gt.mx)[1]*dim(gt.mx)[2])

```

# save_data

```{r save_data}

save.image(file="data/s03_filter_genotypes_feb2016.RData")

```

# final_section

```{r final_section}

sessionInfo()
Sys.time()

```

